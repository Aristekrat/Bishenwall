/*! DonateWare 13-02-2014 */
"use strict";var Bishenwall=angular.module("Bishenwall",["ngRoute"]);Bishenwall.config(function($routeProvider,$locationProvider){$routeProvider.when("/",{templateUrl:"../_show-comments.html",controller:"mainCtrl"}).when("/add-comment",{templateUrl:"../_comment-form.html",controller:"commentCtrl"}).when("/privacy-policy",{templateUrl:"../_privacy-policy.html"}).when("/error",{templateUrl:"../_error.html"}).otherwise({redirectTo:"../_show-comments.html"}),$locationProvider.html5Mode(!0)}),Bishenwall.factory("mainData",["$http",function($http){return{getFirstPage:function(){return $http.get("/getcomments")},getNextPage:function(){}}}]),Bishenwall.factory("spamData",["$http",function($http){return{getReportedComments:function(){return $http.get("/getusers").then(function(response){return response})}}}]),Bishenwall.controller("mainCtrl",["$http","$scope","$timeout","$location","mainData","spamData",function($http,$scope,$timeout,$location,mainData,spamData){var dataWrapper={};mainData.getFirstPage().success(function(response){$scope.comments=response,dataWrapper.comments=response,$timeout(function(){spamData.getReportedComments().then(function(response){dataWrapper.reportedComments=response.data,dataWrapper.reportedComments.length>0&&($scope.findPageIDs(dataWrapper.comments),$scope.findReportedCommentsOnPage(dataWrapper.pageIDs,dataWrapper.reportedComments))})},0)}).error(function(){$location.path("/error")}),$scope.findPageIDs=function(testedArray){if(dataWrapper.pageIDs=[],testedArray.length>0)for(var i=0;i<testedArray.length;i++)if(dataWrapper.pageIDs.push(testedArray[i]._id),testedArray[i].reply.length>0)for(var e=0;e<testedArray[i].reply.length;e++)dataWrapper.pageIDs.push(testedArray[i].reply[e]._id)},$scope.findReportedCommentsOnPage=function(arrayOne,arrayTwo){for(var matchedIDs=[],i=0,lFirst=arrayOne.length;lFirst>i;i++)for(var e=0,lSecond=arrayTwo.length;lSecond>e;e++)arrayOne[i]===arrayTwo[e]&&matchedIDs.push(arrayOne[i]);$scope.$broadcast("dataReady",matchedIDs)},$scope.state={selected:null},$scope.createForm=function(comment){$scope.state.selected=comment},$scope.showReplyForm=function(comment){return $scope.state.selected===comment},$scope.hideReplyForm=function(){$scope.state.selected=null},$scope.reply={},$scope.submitReply=function(comment){var replyMessage={id:comment._id,commentTitle:$scope.reply.replyTitle,commentText:$scope.reply.replyText};$http.post("/comment",replyMessage).success(function(data){comment.reply.push(data),$scope.reply={},$scope.hideReplyForm(),$scope.$broadcast("commentPosted")}).error(function(){$location.path("/error")})}}]),Bishenwall.controller("commentCtrl",["$http","$scope","$location",function($http,$scope,$location){$scope.canSave=function(){return $scope.commentForm.$dirty&&$scope.commentForm.$valid},$scope.postComment=function(){var comment={commentTitle:$scope.comment.title,commentText:$scope.comment.text};$http.post("/comment",comment).success(function(){$location.path("/")}).error(function(){$location.path("/error")})}}]),Bishenwall.directive("notice",["$timeout",function($timeout){return{restrict:"A",template:"<h3>{{outcome}}</h3>",scope:!0,link:function($scope){function removeNotification(){$scope.recentOutcome=!1}$scope.$on("commentPosted",function(){$scope.recentOutcome=!0,$scope.outcome="Comment Posted Successfully",$timeout(removeNotification,4e3)})}}}]),Bishenwall.directive("spam",["$http","$location","$timeout","spamData",function($http,$location){return{restrict:"A",template:"{{buttonText}}",scope:!0,link:function($scope,$element,$attrs){$scope.reported=!1,$scope.buttonText="Report Spam",$scope.setReported=function(){$element.addClass("bwSpamClicked"),$scope.buttonText="Reported",$scope.reported=!0},$scope.reportSpam=function(comment){var reportedComment={id:comment._id};reportedComment.reply=comment.reply?!1:!0,$http.post("/spam",reportedComment).success(function(){$scope.setReported()}).error(function(){$location.path("/error")})},$scope.$on("dataReady",function(event,matchedIDs){for(var i=0;i<matchedIDs.length;i++)matchedIDs[i]===$attrs.id&&$scope.setReported()})}}}]),$(document).ready(function(){$(".bwNeed").click(function(e){e.preventDefault(),$(".bwTheWall p").toggleClass("bwHide")})});